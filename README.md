# Express-Snippets
A set of Node and Express snippets, helpers, tools and middleware.


## Quick Access
- [Create Express App](#create-an-express-app)
- [Middleware](#tools-and-middleware)
  - A list of common middle ware can be found [here](https://expressjs.com/en/resources/middleware.html)
  - [body-parser](#body-parser)
  - [cookie-parser](#cookie-parser)
  - [pg: Postgres connection](#pg)
  - [knex](#knex-middleware)
  - [dotenv](#dotenv-middleware)
  - [morgan: http logger](#morgan)
  - [express-sessions: user sessions](#express-sessions)
  - [ping: a ping TCP wrapper](#ping)
  
  
------------------------


## Create an Express App
[Here's a great resource for setup up w/ a database](https://blog.logrocket.com/setting-up-a-restful-api-with-node-js-and-postgresql-d96d6fc892d8/)

__1.)__ Create a ```package.json``` file by running: ```npm init```

__2.)__ Install Express and Dependencies: ```npm i express```

  __2a.)__ Install Dependencies, if applicable: ```npm i body-parser cors dotenv helmet knex morgan pg```

__3.)__ Create an index.js file for the app: ```touch index.js```

__4.)__ Paste the following code into the index.js:
```javascript
const express = require('express');
const app = express();

const PORT = process.env.port || 3001

app.get('/', (req, res) => {
  res.send('App running...');
});

app.listen(PORT, () => console.log(`App is listening on port ${PORT}...`))
```
__5.)__ Install "nodemon", which is like hot reloading: ```npm i -D nodemon```

__6.)__ Change the "scripts" section to include: 
  ```javascript
  "scripts": {
    "start": "nodemon index.js"
  }
  ```
__7.)__ Then start the server: ```npm start```



-------------
# Middleware

**TIPS:**
- If need access to data generated by middleware to later be read by *other* middleware you can use the: ```req.locals``` object. It will attach that data to the current request.

## Tools and Middleware
*Nearly* all middleware is implemented by telling Express to "*use*" it: ```app.use(middleWare)```

#### ```body-parser```
"body-parser" is a package for handling HTTP requests and parsing the JSON body.
- Install: ```npm i body-parser```

**Example**
```javascript
// sets up json parsing
// accepts encoded urls
  
const bodyParser = require('body-parser');

app.use(bodyParser.json());
app.use(
  bodyParser.urlencoded({
    extended: true
}))
```

#### ```cookie-parser```
"cookie-parser" is a package that handles parsing cookie headers and will populate the ```req.cookies``` property of the request object.
- Install: ```npm i cookie-parser```

**Example**
```javascript
// imports the middleware
const cookieParser = require('cookie-parser');

// tells express to use it
app.use(cookieParser())
```
- Working w/ signed and unsigned cookies
```javascript
// to access cookies 

app.get('/', (req, res) => {
  console.log('Cookies: ', req.cookies);  // Cookies that have not been signed

  console.log('Signed Cookies: ', req.signedCookies)   // Cookies that have been signed
})
```

#### ```dotenv```
"dotenv" is a package for easily integrating environment variables.

```sql
require("dotenv").config();
```


#### ```pg```
"pg" is a package for working with Postgres in Express that includes: connection pooling, async notifications, bulk import/export etc.
- Install: ```npm i pg```

**Example**
```javascript
// setup connection pool
// setup connection details

const Pool = require('pg').Pool;
const pool = new Pool({
  user: 'me',
  host: 'localhost',
  database: 'database name here',
  password: 'database password here',
  port: 5432
})
```

#### ```knex```
"knex" is a SQL query builder, mainly used for Node.js applications with built in model schema creation, table migrations, connection pooling and seeding.

- **NOTE: ```knex``` really works great with ```pg``` to make sure to have that installed already.**
- We can start by creating a ```knexfile.js``` in the root of your project which will act as our configuration for different environments, (e.g. â€“ local development vs production).
- [Here's a useful gist for setup](https://gist.github.com/NigelEarle/80150ff1c50031e59b872baf0e474977)

```sql
// NOTE: you can also pass env variables to the db connection

// create a db connection w/ localhost ONLY
const db = require("knex")({
  client: "pg",
  connection: {
    host: "127.0.0.1",
    user: "",
    password: "",
    database: "dashboard"
  }
});

// setup a config file for db connection that includes environment settings for staging, development, production etc.
module.exports = {
  development: {
    client: 'sqlite3',
    connection: {
      filename: './dev.sqlite3'
    }
  },
  staging: {
    client: 'postgresql',
    connection: {
      database: 'my_db',
      user:     'username',
      password: 'password'
    },
    pool: {
      min: 2,
      max: 10
    },
    migrations: {
      tableName: 'knex_migrations'
    }
  },
  production: {
    client: 'postgresql',
    connection: {
      database: 'my_db',
      user:     'username',
      password: 'password'
    },
    pool: {
      min: 2,
      max: 10
    },
    migrations: {
      tableName: 'knex_migrations'
    }
  }
};

```


#### ```morgan```
"morgan" is an HTTP request logging package.
- Install: ```npm i morgan```

**Example**
```javascript
//import package
const morgan = require('morgan');

app.use(morgan('combined'));

// syntax
morgan(format, options)
```

#### ```express-session```
"express-session" handles user sessions 
- Install: ```npm i express-session```

**Example**
```javascript
const session = require('express-session'):

app.use(session(
  'secret': '343kd833ls8lslk3x'
))

// access the session name
req.session.name = 'Esten';
```


#### ```PING``` 
The ```PING``` middleware is used for opening/closing TCP socket connections to specified hosts in Node.
- Install: ```npm i ping```

**Example**

```javascript
const ping = require('ping');

// DO NOT include "https://"
const hosts ['192.168.8.1', 'echo-alchemist.com', 'sgore.dev'];

hosts.forEach((host, index) => {
  ping.sys.probe(host, (isAlive) => {
    const msg = isAlive ? 'Host: ' + host + ' is alive' : 'Host: ' + host + ' is down';
    console.log(msg);
  });
});

// Promise Version
hosts.forEach((host, index) => {
  ping.sys.probe(host)
    .then(res => console.log(res))
    .catch(err => console.log(err))
})
```








